# Prostsza wersja skryptu PowerShell do generowania klas C# z CEIDG XSD
# Bez skomplikowanych konstrukcji, atwiejsza do debugowania

param(
    [string]$CeidgXsdPath = "CEIDG-1_10122023.xsd",
    [string]$OutputDir = "Generated",
    [string]$CacheDir = "SchemaCache",
    [switch]$SkipDownload = $false,
    [switch]$UseUniqueNames = $false
)

Write-Host "=== Generator klas CEIDG - wersja uproszczona ===" -ForegroundColor Green

# Krok 1: Sprawd藕 czy xscgen jest zainstalowany
Write-Host "`n[1/6] Sprawdzanie xscgen..." -ForegroundColor Cyan
$xscgenInstalled = $null -ne (dotnet tool list -g | Select-String "dotnet-xscgen")
if (-not $xscgenInstalled) {
    Write-Host "   Instalowanie xscgen..." -ForegroundColor Yellow
    dotnet tool install --global dotnet-xscgen
    if ($LASTEXITCODE -ne 0) {
        Write-Host "   BD: Nie mo偶na zainstalowa xscgen!" -ForegroundColor Red
        exit 1
    }
}
else {
    Write-Host "   OK: xscgen jest zainstalowany" -ForegroundColor Green
}

# Krok 2: Przygotuj katalogi
Write-Host "`n[2/6] Przygotowanie katalog贸w..." -ForegroundColor Cyan
if (Test-Path $OutputDir) {
    Remove-Item $OutputDir -Recurse -Force
}
New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null
New-Item -ItemType Directory -Path $CacheDir -Force | Out-Null
Write-Host "   OK: Katalogi przygotowane" -ForegroundColor Green

# Krok 3: Pobierz zewntrzne schematy (jeli nie pominito)
if (-not $SkipDownload) {
    Write-Host "`n[3/6] Pobieranie zewntrznych schemat贸w..." -ForegroundColor Cyan
    
    $schemas = @{
        "osoba.xsd" = "http://crd.gov.pl/xml/schematy/osoba/2009/11/16/osoba.xsd"
        "meta.xsd" = "http://crd.gov.pl/xml/schematy/meta/2009/11/16/meta.xsd"
        "struktura.xsd" = "http://crd.gov.pl/xml/schematy/struktura/2009/11/16/struktura.xsd"
        "xmldsig-core-schema.xsd" = "http://www.w3.org/TR/xmldsig-core/xmldsig-core-schema.xsd"
    }
    
    foreach ($file in $schemas.Keys) {
        $localPath = Join-Path $CacheDir $file
        if (Test-Path $localPath) {
            Write-Host "   OK: $file (cache)" -ForegroundColor Gray
        }
        else {
            Write-Host "   Pobieranie: $file" -ForegroundColor Gray
            try {
                Invoke-WebRequest -Uri $schemas[$file] -OutFile $localPath -UseBasicParsing
                Write-Host "   OK: $file (pobrano)" -ForegroundColor Green
            }
            catch {
                Write-Host "   UWAGA: Nie mo偶na pobra $file" -ForegroundColor Yellow
            }
        }
    }
}
else {
    Write-Host "`n[3/6] Pomijanie pobierania schemat贸w (--SkipDownload)" -ForegroundColor Yellow
}

# Krok 4: Przygotuj lokaln kopi g贸wnego XSD
Write-Host "`n[4/6] Przygotowanie g贸wnego pliku XSD..." -ForegroundColor Cyan
$localXsdPath = Join-Path $CacheDir "CEIDG-1_10122023_local.xsd"
$content = Get-Content $CeidgXsdPath -Raw

# Zamie URL-e na lokalne cie偶ki
$replacements = @{
    'schemaLocation="http://crd.gov.pl/xml/schematy/osoba/2009/11/16/osoba.xsd"' = 'schemaLocation="osoba.xsd"'
    'schemaLocation="http://crd.gov.pl/xml/schematy/meta/2009/11/16/meta.xsd"' = 'schemaLocation="meta.xsd"'
    'schemaLocation="http://crd.gov.pl/xml/schematy/struktura/2009/11/16/struktura.xsd"' = 'schemaLocation="struktura.xsd"'
    'schemaLocation="http://www.w3.org/TR/xmldsig-core/xmldsig-core-schema.xsd"' = 'schemaLocation="xmldsig-core-schema.xsd"'
}

foreach ($old in $replacements.Keys) {
    $content = $content -replace [regex]::Escape($old), $replacements[$old]
}

Set-Content -Path $localXsdPath -Value $content -Encoding UTF8
Write-Host "   OK: Plik przygotowany" -ForegroundColor Green

# Krok 5: Stw贸rz plik mapowania namespace'贸w
Write-Host "`n[5/6] Tworzenie mapowania namespace'贸w..." -ForegroundColor Cyan
$namespacesPath = Join-Path $CacheDir "namespaces.txt"
@"
# Mapowanie namespace'贸w XML na C#
http://crd.gov.pl/wzor/2023/12/10/ = Ceidg.Wzor
http://crd.gov.pl/xml/schematy/osoba/2009/11/16/ = Ceidg.Osoba
http://crd.gov.pl/xml/schematy/meta/2009/11/16/ = Ceidg.Meta
http://crd.gov.pl/xml/schematy/struktura/2009/11/16/ = Ceidg.Struktura
http://www.w3.org/2000/09/xmldsig# = Ceidg.XmlDSig
"@ | Set-Content -Path $namespacesPath -Encoding UTF8
Write-Host "   OK: Mapowanie utworzone" -ForegroundColor Green

# Krok 6: Generuj klasy C#
Write-Host "`n[6/6] Generowanie klas C#..." -ForegroundColor Cyan

# Przejd藕 do katalogu cache (wa偶ne dla relative paths w XSD)
Push-Location $CacheDir

try {
    # Buduj argumenty
    $args = @(
        "--nf", "namespaces.txt",
        "--separateFiles",
        "--output", "..\$OutputDir",
        "--nullable",
        "--netCore",
        "--namespaceHierarchy",
        "CEIDG-1_10122023_local.xsd"
    )
    
    if ($UseUniqueNames) {
        $args = @("--uniqueTypeNames") + $args
    }
    
    Write-Host "   Wywoanie: xscgen $($args -join ' ')" -ForegroundColor Gray
    
    # Wykonaj xscgen
    & xscgen $args
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "   OK: Klasy wygenerowane!" -ForegroundColor Green
    }
    else {
        Write-Host "   BD: xscgen zwr贸ci kod bdu $LASTEXITCODE" -ForegroundColor Red
        exit $LASTEXITCODE
    }
}
finally {
    Pop-Location
}

# Podsumowanie
Write-Host "`n=== PODSUMOWANIE ===" -ForegroundColor Green
if (Test-Path $OutputDir) {
    $files = Get-ChildItem -Path $OutputDir -Filter "*.cs" -Recurse
    Write-Host "Wygenerowano plik贸w: $($files.Count)" -ForegroundColor Cyan
    Write-Host "Lokalizacja: $((Get-Item $OutputDir).FullName)" -ForegroundColor Cyan
    
    # Poka偶 struktur
    Write-Host "`nStruktura katalog贸w:" -ForegroundColor Yellow
    Get-ChildItem -Path $OutputDir -Directory | ForEach-Object {
        Write-Host "   $($_.Name)" -ForegroundColor Gray
        Get-ChildItem -Path $_.FullName -Directory | ForEach-Object {
            Write-Host "      $($_.Name)" -ForegroundColor DarkGray
        }
    }
    
    # Przykadowe pliki
    Write-Host "`nPrzykadowe wygenerowane klasy:" -ForegroundColor Yellow
    $files | Select-Object -First 5 | ForEach-Object {
        $relativePath = $_.FullName.Replace("$PWD\", "")
        Write-Host "   $relativePath" -ForegroundColor Gray
    }
}

Write-Host "`n=== JAK U呕YWA ===" -ForegroundColor Green
Write-Host @"
1. Dodaj do projektu .csproj:
   <ItemGroup>
     <Compile Include="$OutputDir\**\*.cs" />
   </ItemGroup>

2. W kodzie C#:
   using Ceidg.Wzor;
   using Ceidg.Osoba;
   
   var instytucja = new InstytucjaTyp();

3. Jeli s konflikty nazw, uruchom ponownie z:
   .\generate-ceidg-simple.ps1 -UseUniqueNames
"@ -ForegroundColor Cyan

Write-Host "`nGotowe!" -ForegroundColor Green